resource "google_clouddeploy_automation" "<%= ctx[:primary_resource_id] %>" {
  provider = google-beta
  name     = "<%= ctx[:vars]['automation'] %>"
  location = "us-central1"
  delivery_pipeline = google_clouddeploy_delivery_pipeline.pipeline.name
  service_account = "<%= ctx[:vars]['service_account'] %>"
  selector {
    targets {id = "*"}
  }
  rules {
    promote_release_rule{
      id = "promote-release"
    }
  }
}

resource "google_clouddeploy_delivery_pipeline" "pipeline" {
  provider = google-beta
  name = "<%= ctx[:vars]['delivery_pipeline'] %>"
  location = "us-central1"
  serial_pipeline  {
    stages {
      target_id = "test"
      profiles = ["test-profile"]
    }
  }
 }
